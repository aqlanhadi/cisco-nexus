{% extends 'nexus/layout.html' %}
{% load static %}
{% load fullcalendar_tags %}
{% load table_tags %}
{% block breadcrumbs %}
    <span class="kt-subheader__separator kt-hidden"></span>
    <div class="kt-subheader__breadcrumbs">
        <a href="{% url 'dashboard' %}" class="kt-subheader__breadcrumbs-home"><i class="flaticon2-shelter"></i></a>
        <span class="kt-subheader__breadcrumbs-separator"></span>
        <a href="" class="kt-subheader__breadcrumbs-link">
            Attendances </a>
        <span class="kt-subheader__breadcrumbs-separator"></span>
        <a href="" class="kt-subheader__breadcrumbs-link">
            Register Attendances </a>
    </div>
{% endblock breadcrumbs %}
{% block content %}
<script>
    $(function() {
        var csrftoken = Cookies.get('csrftoken');
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        function set_icon(status) {
            if (status == 'U') {
                $('#verified-icon').text('cancel')
                $('#verified-icon').css('color', 'red')

            } else {
                $('#verified-icon').text('check_circle')
                $('#verified-icon').css('color', 'green')
            }
        };

        function set_text(status) {
            var item = $('#shift-verify')
            if (status == 'U') {
                item.removeClass('btn-danger')
                item.text('Verify')
                item.addClass('btn-success')
            } else {
                item.removeClass('btn-success')
                item.text('Unverify')
                item.addClass('btn-danger')
            }
        }

        function fetch_events(response) {
            $('#guard-id__placeholder').text("ID#: " + response.g_id);
            $('#guard-name__placeholder').text(response.name);
            $('#guard-location').text(response.location);
            $('#guard-pic').attr('src', response.pic_url);

            $('#salary-amount').text("RM" + response.sum_pay);
            $('#v_pay').text("RM " + response.v_pay);
            $('#u_pay').text("RM " + response.u_pay);

            $('#calendar').fullCalendar('removeEvents');
            $('#calendar').fullCalendar('addEventSource', response.u_data);
            $('#calendar').fullCalendar('addEventSource', response.v_data);
            $('#calendar').fullCalendar('refetchEvents');
            $('#month-salary').text(response.sum_pay);
        }


        var guard_id = 0;
        var dtopt = {
            "searching": false,
            "paging": false,
            "info": false,
            "initComplete": function() {
                $(document).on('click', '#DataTables_Table_0 tbody tr', function() {
                    id = $(this).attr('id');
                    $.ajax({
                        type: 'GET',
                        url: "{% url 'attd-get-shift' %}",
                        data: {'p_id': id},
                        success: function (response) {
                            $('#calendar-area').show()
                            $('#guard-details').show()
                            $('#review-area').show()
                            console.log("ajax1 -> " + response.data)
                            if (response.u_data!=undefined && response.v_data!=undefined) {
                                fetch_events(response);
                                guard_id = response.g_id;
                            }
                        }
                    });
                });
            }
        };
        var req = null;
        var sub_req = null;
        var verify_btn = null;
        var dt = datatableview.initialize($('.datatable'), dtopt);
        var table = dt.api;
        $('.datatable').addClass("ui celled table")
        var calopt = {
            header: {
                left: 'today',
                center: 'title',
                right: 'month, agendaWeek'
            },
            plugins: [ 'interaction' ],
            selectable: true,
            eventClick: function(info) {
                $(document).off('click', '#shift-verify');
                $(document).off('click', '#submit-salary')
                $('#shift-details').show()
                $('#salary-footer').show()
                var hours_worked = (info.end - info.start) / 3600000;
                start = info.start.format()
                verify_btn = $.ajax({
                    type: 'GET',
                    url: "{% url 'attd-get-details' %}",
                    data: {'date':start, 'g_id':guard_id},
                    beforeSend: function() {
                        if (verify_btn != null) {
                            verify_btn.abort()
                        }
                    },
                    success: function(response) {
                        console.log("ajax2 -> " + info.color)
                        $('#shift-date').text(info.start.format("dddd, MMMM D, Y"));
                        $('#clocked-start').text(response.start);
                        $('#clocked-end').text(response.end);
                        $('#clocked-duration').text(response.duration + " hrs");
                        $('#clocked-duration').css('color', response.d_col);
                        set_text(response.status)
                        if (response.status == 'U') {
                            $('#verified-icon').text('cancel')
                            $('#verified-icon').css('color', 'red')
                        } else {
                            $('#verified-icon').text('check_circle')
                            $('#verified-icon').css('color', 'green')
                        }                                        
                        $(document).on('click', '#shift-verify',function() {
                            console.log("clicked verify")                                            
                            req = $.ajax({
                                url: "{% url 'attd-verify' %}",
                                data: {'date':start, 'g_id':guard_id},
                                success: function(response) {
                                    console.log(response.status)
                                    set_icon(response.status)
                                    set_text(response.status)
                                    $.ajax({
                                        url: "{% url 'attd-get-shift' %}",
                                        data: {'p_id': guard_id},
                                        success: function(response) {
                                            fetch_events(response)
                                        }
                                    });
                                }
                            });
                        });
                        $(document).on('click', '#submit-salary', function() {
                            console.log("clicked submit")
                            sub_req = $.ajax({
                                url: "{% url 'attd-submit' %}",
                                data: {'g_id': guard_id},
                                success: function() {
                                    console.log('salary-saved')
                                }
                            });
                        });
                    }
                });
            },
            dayClick: function(date, jsEvent, view) {
                $('#calendar').fullCalendar('gotoDate',date);
                $('#calendar').fullCalendar('changeView','agendaWeek');
            }
        };
        $('#calendar').fullCalendar(calopt)
        var eventLoaded = false;
    }); 
</script>
<div class="kt-content kt-grid__item kt-grid__item--fluid" id="kt_content">
    <div class='row'>
        <div class='col'>
            <div class='kt-portlet' id='guard-details' style='display:none;'>
                <div class='kt-portlet__body'>
                    <div class='row'>
                        <div class='col-4'>
                            <div class="kt-profile__main-pic">
                            <!-- change pic later -->
                                <img src="" alt="" id='guard-pic' style='border-radius:50%; max-width:100%; max-height:100%'/>
                            </div>
                            </div>
                        <div class='col-8'>
                        <div class='row'>
                                <h6 class="col-sm text-left font-weight-light" id='guard-id__placeholder'></h6>
                            </div>
                            <div class='row'>
                                <h3 class="col-sm text-left font-weight-light" id='guard-name__placeholder'></h3>
                            </div>
                            <div class='row'>
                                <h6 class="col-sm text-left font-weight-light" id='guard-location'></h6>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <div class='kt-portlet__foot' id='details-footer'>
                    <div class='row d-flex flex-row-reverse'>
                        <button type='button' class='ml-3 mr-2 btn btn-primary btn-pill' id='next-guard'>Next</button>
                        <button type='button' class='btn btn-secondary btn-pill' id='submit-salary'>Submit Verified Salary</button>
                    </div>
                </div>
            </div>
            <div class='kt-portlet' id='table-area'>
                <div class='kt-portlet__body'>
                    <div class='kt_datatable kt-datatable kt-datatable--default kt-datatable--brand kt-datatable--loaded' id='local_data'>        
                        {{ datatable }}
                    </div>
                </div>
            </div>
        </div>
        <div class='col-6'>
            <div class='kt-portlet' id='calendar-area' style='display:none;'>
                <div class='kt-portlet__body'>
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
        <div class='col'>
            <div class='kt-portlet' id='review-area' style='display:none;'>
                <div class='kt-portlet__body'>
                    <div id='salary-details'>
                        <h6 id='shift-date' class='text-sm-center font-weight-light text-uppercase'>November 2019</h6>
                        <h2 id='salary-amount' class='text-center font-weight-bold text-uppercase'>RM 0<h2>
                        <div class="mt-4 row">
                            <h6 class="col-sm text-center">
                            Verified
                            </h6><h6 class="col-sm text-center">
                            Unverifed
                            </h6>
                            <div class="w-100"></div>
                            <h6 class="col-sm text-center" id='v_pay'>
                            RM 0
                            </h6>
                            <h6 class="col-sm text-center" id='u_pay'>
                            RM 0
                            </h6>                
                        </div>
                    </div>

                    <div class='' style='display:none' id='shift-details'>
                        <div class="mt-3 row">
                            <h6 class="col-sm text-center">
                            Scheduled shift
                            </h6>
                        </div>
                        <div class="row">
                            <h6 class="col-sm text-left font-weight-light">
                            07:00
                            </h6>
                            <h6 class="col-sm text-center font-weight-light">
                            12 hrs
                            </h6>
                            <h6 class="col-sm text-right font-weight-light">
                            19:00
                            </h6>
                        </div>

                        <div class="mt-3 row">
                            <h6 class="col-sm text-center">
                            Clocked hours
                            </h6>
                        </div>
                        
                        <div class="row">
                            <h6 class="col-sm text-left" id='clocked-start'>
                            06:56
                            </h6>
                            <h6 class="col-sm text-center" id='clocked-duration'>
                            12:07 hrs
                            </h6>
                            <h6 class="col-sm text-right" id='clocked-end'>
                            19:03
                            </h6>
                        </div>
                        <div class="mt-4 row">
                            <h6 class="col-sm text-left">
                            </h6>
                            <h6 class="col-sm text-center">
                            Fulfilled
                            </h6><h6 class="col-sm text-center">
                            Verified
                            </h6>
                            <div class="w-100"></div>
                            <h6 class="col-sm text-left">
                            Entry status
                            </h6>
                            <h6 class="material-icons col-sm text-center" style="color:green;" id='fulfilled-icon'>check_circle</h6>
                            <h6 class="material-icons col-sm text-center" style="color:red;" id='verified-icon'>cancel</h6>
                            <div class="w-100"></div>
                            <h6 class="col-sm text-left"></h6>
                            <h6 class="col-sm text-left"></h6>
                        </div>
                    </div>
                </div>
                <div class='kt-portlet__foot' style='display:none' id='salary-footer'>
                    <div class='row d-flex flex-row-reverse'>
                        <button type='button' class='ml-3 mr-2 btn btn-success btn-pill' id='shift-verify'>Approve Entry</button>
                        <button type='button' class='ml-3 mr-2 btn btn-primary btn-pill' id='next-guard'>Next</button>
                        <button type='button' class='btn btn-secondary btn-pill' id='prev-guard'>Previous</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}